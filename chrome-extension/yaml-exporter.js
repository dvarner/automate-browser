// YAML Exporter - Converts recorded actions to YAML workflow format

function actionsToYAML(actions, workflowName = 'Recorded Workflow', browser = 'chrome') {
  // Remove duplicate actions and clean up
  const cleanedActions = cleanActions(actions);

  // Build YAML structure
  let yaml = `# Auto-generated by Chrome Extension Recorder\n`;
  yaml += `# Review and edit as needed:\n`;
  yaml += `#   - Add wait_for_human steps for logins/CAPTCHAs\n`;
  yaml += `#   - Add extract/extract_table for data scraping\n`;
  yaml += `#   - Verify selectors work correctly\n`;
  yaml += `#   - Add waits if pages load slowly\n\n`;

  yaml += `name: "${workflowName}"\n`;
  yaml += `browser: "${browser}"\n`;
  yaml += `timeout: 30\n\n`;

  yaml += `steps:\n`;

  cleanedActions.forEach((action, index) => {
    yaml += actionToYAML(action, index);
  });

  return yaml;
}

// Convert single action to YAML
function actionToYAML(action, index) {
  let yaml = `  - action: ${action.action}\n`;

  switch (action.action) {
    case 'navigate':
      yaml += `    url: "${action.url}"\n`;
      break;

    case 'click':
      yaml += `    selector: "${action.selector}"\n`;
      if (action.text) {
        yaml += `    # Element text: "${action.text}"\n`;
      }
      break;

    case 'fill':
      yaml += `    selector: "${action.selector}"\n`;
      yaml += `    value: "${action.value}"\n`;
      if (action.sensitive) {
        yaml += `    sensitive: true\n`;
      }
      break;

    case 'wait':
      if (action.selector) {
        yaml += `    selector: "${action.selector}"\n`;
      } else if (action.seconds) {
        yaml += `    seconds: ${action.seconds}\n`;
      }
      break;

    default:
      // Generic action
      Object.keys(action).forEach(key => {
        if (key !== 'action' && key !== 'timestamp') {
          yaml += `    ${key}: "${action[key]}"\n`;
        }
      });
  }

  yaml += `\n`;
  return yaml;
}

// Clean up actions (remove duplicates, etc.)
function cleanActions(actions) {
  if (!actions || actions.length === 0) return [];

  const cleaned = [];
  let lastAction = null;

  actions.forEach(action => {
    // Skip if identical to last action (duplicate)
    if (lastAction &&
        lastAction.action === action.action &&
        lastAction.selector === action.selector &&
        lastAction.value === action.value &&
        lastAction.url === action.url) {
      return; // Skip duplicate
    }

    // For fill actions, only keep the final value for same selector
    if (action.action === 'fill' && lastAction && lastAction.action === 'fill' &&
        lastAction.selector === action.selector) {
      // Replace last action with this one (latest value)
      cleaned.pop();
    }

    cleaned.push(action);
    lastAction = action;
  });

  return cleaned;
}

// Preview YAML in readable format
function previewYAML(yaml) {
  return `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">${escapeHtml(yaml)}</pre>`;
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Export to file
function downloadYAML(yaml, filename = 'workflow.yaml') {
  const blob = new Blob([yaml], { type: 'text/yaml' });
  const url = URL.createObjectURL(blob);

  chrome.downloads.download({
    url: url,
    filename: filename,
    saveAs: true
  }, () => {
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });
}
